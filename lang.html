<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Learning Languages</title>
</head>
<body>
  
  <div style="font-size: 30px; color: green;">
    <span id="speaking_phrase">Test</span>
  </div>
  <label for="phrases_to_learn">Phrases To Learn:</label><br>
  <textarea id="phrases_to_learn" rows="4" cols="50"></textarea><br><br>
  
  <label for="known_phrases">Known Phrases:</label><br>
  <textarea id="known_phrases" rows="4" cols="50"></textarea><br><br>
  
  <label for="language_to_learn">Language To Learn:</label>
  <select id="language_to_learn">
    <option value="en-US">English</option>
    <option value="fr-FR">French</option>
    <option value="de-DE">German</option>
    <option value="nl-NL">Dutch</option>
    <option value="es-ES">Spanish</option>
    <option value="it-IT">Italian</option>
    <option value="ru-RU">Russian</option>
  </select><br><br>

  <label for="known_language">Known Language:</label>
  <select id="known_language">
    <option value="en-US">English</option>
    <option value="fr-FR">French</option>
    <option value="de-DE">German</option>
    <option value="nl-NL">Dutch</option>
    <option value="es-ES">Spanish</option>
    <option value="it-IT">Italian</option>
    <option value="ru-RU">Russian</option>
  </select><br><br>
  
  <label for="way_of_showing">Way of Showing:</label>
  <select id="way_of_showing">
    <option value="sequential">Sequential</option>
    <option value="random">Random</option>
  </select><br><br>
  
  <button id="startButton" onclick="startSpeech()">Start</button>
  <button id="stopButton" onclick="stopSpeech()">Stop</button>
  
  <script>
    const isDebug = true;
    
    // sleep time expects milliseconds
    function sleep (time) {
      return new Promise((resolve) => setTimeout(resolve, time));
    }
    // Load saved values from local storage
    window.onload = function() {
      document.getElementById('phrases_to_learn').value = localStorage.getItem('phrases_to_learn') || '';
      document.getElementById('known_phrases').value = localStorage.getItem('known_phrases') || '';
      document.getElementById('language_to_learn').value = localStorage.getItem('language_to_learn') || 'en-US';
      document.getElementById('known_language').value = localStorage.getItem('known_language') || 'en-US';
      document.getElementById('way_of_showing').value = localStorage.getItem('way_of_showing') || 'sequential';
    }

    var intervalID;
    var phrasesToLearn = [];
    var knownPhrases = [];
    var languageToLearn = "";
    var knownLanguage = "";
    var isSpeakingInProgress = false;
    var numberOfRepetition = 3;
    var wayOfShowing = "sequential";
    var currentPhraseIndex = 0;

    async function speakOnce() {
      
      var phraseToLearn = "";
      var knownPhrase = "";
      
      if (wayOfShowing == "random") {
        var randomIndex = Math.floor(Math.random() * phrasesToLearn.length);
        phraseToLearn = phrasesToLearn[randomIndex];
        knownPhrase = knownPhrases[randomIndex];
      } else if (wayOfShowing == "sequential") {
        phraseToLearn = phrasesToLearn[currentPhraseIndex];
        knownPhrase = knownPhrases[currentPhraseIndex];
        currentPhraseIndex++;
        if (currentPhraseIndex >= phrasesToLearn.length) {
          currentPhraseIndex = 0;
        }
      }
        document.getElementById('speaking_phrase').innerHTML = phraseToLearn + " (" + languageToLearn + ") - " + knownPhrase + " (" + knownLanguage + ")";

      var msgToLearn = new SpeechSynthesisUtterance();
      msgToLearn.text = phraseToLearn;
      msgToLearn.lang = languageToLearn;

      var msgKnown = new SpeechSynthesisUtterance();
      msgKnown.text = knownPhrase;
      msgKnown.lang = knownLanguage;
      var repeatCount = 0;

      msgToLearn.onend = async function(event) {
        logMsg("Finish speaking phrase to learn: " + repeatCount);
        logMsg("Wait 1 second");
        repeatCount++;
        await sleep(1000);
        if (repeatCount < numberOfRepetition) {
          logMsg("Start speaking phrase to learn: " + repeatCount);
          speechSynthesis.speak(msgToLearn);
        } else {
          if (isSpeakingInProgress) {
            setTimeout(speakOnce, 1000);
          }
        }
      }
      msgKnown.onend = async function(event) {
        logMsg("Finish speaking known phrase: " + repeatCount);
        logMsg("Wait 2 second");
        await sleep(1000);
        logMsg("Start speaking phrase to learn" + repeatCount);
        speechSynthesis.speak(msgToLearn);
      };
      logMsg("Start speaking known phrase: " + repeatCount);
      speechSynthesis.speak(msgKnown);
      
      /*msgToLearn.onend = async function(event) {
        logMsg("Finish speaking phrase to learn" + repeatCount);
        logMsg("Wait 1 second");
        await sleep(2000);
        logMsg("Start speaking known phrase" + repeatCount);
        speechSynthesis.speak(msgKnown);
      };
      logMsg("Start speaking phrase to learn" + repeatCount);
      speechSynthesis.speak(msgToLearn);*/
    }
    
    async function startSpeech() {
	  await requestWakeLock();
      document.getElementById('startButton').disabled = true;
      document.getElementById('stopButton').disabled = false;
      isSpeakingInProgress = true;

      phrasesToLearn = document.getElementById('phrases_to_learn').value.trim().split('\n');
      knownPhrases = document.getElementById('known_phrases').value.trim().split('\n');
      languageToLearn = document.getElementById('language_to_learn').value;
      knownLanguage = document.getElementById('known_language').value;
      wayOfShowing = document.getElementById('way_of_showing').value;

      setTimeout(speakOnce, 100);
    }

    async function stopSpeech() {
	  await releaseWakeLock();
      isSpeakingInProgress = false;
      document.getElementById('startButton').disabled = false;
      document.getElementById('stopButton').disabled = true;
    }

    function speakText(text, language) {
      logMsg("Start speaking text " + text + " in " + language);
      var msg = new SpeechSynthesisUtterance();
      msg.text = text;
      msg.lang = language;
      speechSynthesis.speak(msg);
      logMsg("Finish speaking text " + text + " in " + language);
    }

    // Save values to local storage
    window.onbeforeunload = function() {
      localStorage.setItem('phrases_to_learn', document.getElementById('phrases_to_learn').value);
      localStorage.setItem('known_phrases', document.getElementById('known_phrases').value);
      localStorage.setItem('language_to_learn', document.getElementById('language_to_learn').value);
      localStorage.setItem('known_language', document.getElementById('known_language').value);
      localStorage.setItem('way_of_showing', document.getElementById('way_of_showing').value);
    }
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          logMsg('Wake Lock is active');
          wakeLock.addEventListener('release', () => {
            logMsg('Wake Lock release event happened');
            wakeLock = null;
          });
        } catch (err) {
          logMsg('Wake Lock request failed:', err.message);
          wakeLock = null;
        }
      } else {
        logMsg('Wake Lock API is not supported in this browser.');
      }
    }

    async function releaseWakeLock() {
      if (wakeLock !== null) {
        try {
          await wakeLock.release();
          wakeLock = null;
          logMsg('Wake Lock released');
        } catch (err) {
          logMsg('Wake Lock release failed:', err.message);
        }
      }
    }
    
    function logMsg(msg, objectToLog = null, isError = false, forceDebug = false) {
      if ((isDebug) || (forceDebug)) {
        const currDate = getCurrDateAsString();
        if (objectToLog) {
          if (isError) {
            console.error(`[${currDate}] [ERROR] ${msg}`, objectToLog);
          } else {
            console.log(`[${currDate}] [DEBUG] ${msg}`, objectToLog);
          }
        } else {
          if (isError) {
            console.error(`[${currDate}] [ERROR] ${msg}`);
          } else {
            console.log(`[${currDate}] [DEBUG] ${msg}`);
          }
        }
      }
    }
	
    function getCurrDateAsString(isISO8601DateFormat = false) {
      const date = new Date();
      const year = date.getFullYear();
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      const milliseconds = String(date.getMilliseconds()).padStart(3, '0');

      if (isISO8601DateFormat) {
        return `${year}${month}${day}_${hours}${minutes}${seconds}`;
      } else {
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
      }
    }
  </script>
</body>
</html>
